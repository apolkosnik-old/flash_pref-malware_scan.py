#!/usr/bin/env python
"""
#=================================================
#
# FILE: flash_pref-malware_scan.py
#
#
# DESCRIPTION: This script is used for listing and 
#	submitting urls that have been created under the 
#	flash player preferences folder while browsing
#	with Firefox. 
#	
#	The url list is submitted to VirusTotal.com
#	public API to check each of the urls if they are 
#	known as a "Malware site"
#	against diffrent antivirus vendors. 
#	You must have a virustotal.com
#	account and a public API key to use this program.
#
# BUGS: not yet configured for windows xp, vista, 7, bt
# NOTES: Coded using Python 2.6.1 on OSX 10.6
# AUTHOR: Alejandro Laboy - alejandro[AT]vliot.com
# CREATED: 7/23/11
#=================================================
"""
import sys
import os
import re
import string
import json
import urllib
import urllib2
import time
"""
"""
def function_one(ruta):
 cn = 1
 for urlss in os.listdir(ruta):
 	urlsss=re.sub(r'[^\w\-\.]', ' ', urlss)
  	c = urlsss.replace('settings.sol', '')
  	c = c.replace('.DS_Store','')
  	b = c.strip()
  	if b == '':
		print "End of urls reached\n URLS found:", cn-1, " will now exit."
   	 	break
   	 	sys.exit()
   	"""
   	SOME CODE USED FROM:
   	http://www.virustotal.com/advanced.html#publicapi
   	
   	"""
	url = "https://www.virustotal.com/api/get_url_report.json"
	parameters = {"resource": ""+ b + "", "key": "YOUR VIRUSTOTAL API KEY GOES HERE"}
	data = urllib.urlencode(parameters)
	req = urllib2.Request(url, data)
	response = urllib2.urlopen(req)
	jsonn = response.read()
	"""
	UNCOMMENT THE FOLLOWING FOR VERBOSITY 
	
	print " SCANNING: "+jsonn+"\n" 
	"""
	m = re.search('(?<=Mal)ware\ssite', jsonn)
	if m == None:
		print "\t"+b+" is not flagged. \n"
	else:	
		n = m.group()
		if n == 'ware site':
			print "The url "+b+"\n IS flagged as a Malware site \n"
		else:
			print "\t"+b+" is not flagged as a Malware site. \n"
	"""
	create counter
	"""
	cn += 1
	print "Submitting url  number: ", cn
	if cn == 18:
			print "sleeping for 5 minutes to continue submitting the rest of the urls (virustotal API rules) ..."
			time.sleep(300)
	"""
	end counter
	"""	
if len(sys.argv) >= 2:
	def fun():
		print """
		 DESCRIPTION: This script is used for listing and submitting
		urls that have been created under the flash player preferences folder
		while using the Firefox browser. 
		The url list is submitted to VirusTotal.com public API
		to check each of the urls if they are known as a "Malware site"
		against diffrent antivirus vendors. You must have a virustotal.com
		account and a public API key to use this program. 
		"""
		sys.exit()
	fun()
"""
MAIN CODE

"""
"""
DETECT OS:
"""
x = os.uname()
a =  list(x)
if x[-5] == 'Darwin':
	name=os.getlogin()
	ruta1='/Users/'+name+'/Library/Preferences/Macromedia/Flash Player/macromedia.com/support/flashplayer/sys/'
	function_one(ruta1)
if a[-4] == 'bt':
	#backtrack 5
	ruta2='/pentest/web/mantra/data/.macromedia/Flash_Player/macromedia.com/support/flashplayer/sys/'
        function_one(ruta2)		